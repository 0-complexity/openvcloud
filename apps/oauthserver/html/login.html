<!DOCTYPE html>
<!--[if lt IE 7]>      <html lang="en" ng-app="oauthserver" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html lang="en" ng-app="oauthserver" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html lang="en" ng-app="oauthserver" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html lang="en" ng-app="oauthserver" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>GreenITGlobe Login</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/angular-material/0.10.1/angular-material.min.css">
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular-route.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular-aria.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular-animate.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/angular-material/0.10.1/angular-material.js"></script>

  <style>
body {
  background: #817E6A url('../html/background.jpg') no-repeat fixed right;
}
header img {
  margin: 10px auto 0 auto;
  display: inherit;
}
.login-page {
  width: 600px;
  margin: 100px auto 20px auto;
}
.login-page md-whiteframe {
  background: #fff;
  margin: 20px;
}
.login-page md-whiteframe .login-form {
  width: 568px;
  padding: 16px;
}
.login-page md-whiteframe .login-form md-input-container {
  padding: 0 0 16px 0;
}
.login-page md-whiteframe .login-form .form-error {
  color: red;
  font-size: 0.7em;
}
.login-page md-whiteframe .login-form .security-code-error {
  height: 1em;
}
.login-page md-toolbar {
  background-color: #f2f2f2;
}
.red {
  color: red;
}
[ng\:cloak], [ng-cloak], .ng-cloak {
  display: none;
}
  </style>
</head>
<body>
  <!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
  <![endif]-->

  <header>
    <md-toolbar>
      <img src="../html/logo.png">
    </md-toolbar>
  </header>

  <div class="login-page" ng-controller="LoginPageController">
    <md-whiteframe class="md-whiteframe-z4" layout="column" layout-fill layout-align="center center">
      <md-toolbar>
        <span flex></span>
        <h2 class="md-toolbar-tools md-toolbar-tools-bottom">
          <span class="md-flex">Sign in to GreenITGlobe</span>
        </h2>
      </md-toolbar>
      <md-content class="login-form">
        <form>
          <md-input-container>
            <label>Login</label>
            <input ng-model="login" name="login" type="text" autofocus>
          </md-input-container>
          <div class="form-error" ng-switch="formErrors.login" ng-cloak ng-show="formErrors.login">
            <div ng-switch-when="required">You must enter a login.</div>
          </div>

          <md-input-container>
            <label>Password</label>
            <input ng-model="password" name="password" type="password">
          </md-input-container>
          <div class="form-error" ng-switch="formErrors.password" ng-cloak ng-show="formErrors.password">
            <div ng-switch-when="invalid">The login or password you entered is incorrect.</div>
            <div ng-switch-when="required">You must enter a password.</div>
          </div>

          <div ng-cloak ng-show="needsTwoFactorAuthentication">
            <md-input-container>
              <label>Authentication Code</label>
              <input ng-model="securityCode" name="securityCode" type="text">
            </md-input-container>
            <div class="form-error security-code-error" ng-switch="formErrors.securityCode">
              <div ng-switch-when="invalid">The code you entered was invalid.</div>
              <div ng-switch-when="required">You must enter a 6-digit security code.</div>
            </div>
          </div>

          <div layout="row">
            <span flex></span>
            <md-button type="submit" class="md-primary" ng-click="next()">Log in</md-button>
          </div>
        </form>
      </md-content>
    </md-whiteframe>
  </div>

  <script>
angular.module('oauthserver', [
  'ngRoute',
  'ngMaterial',
]);

angular.module('oauthserver').config([
  '$mdThemingProvider',
  function($mdThemingProvider) {
    $mdThemingProvider.theme('default')
      .primaryPalette('grey');
  }
]);

angular.module('oauthserver').factory('api', [
  function() {
    var self = {
      baseURL: '',

      resource: resource,
    };

    function resource(path) {
      return self.baseURL + path;
    }

    return self;
  }
]);

angular.module('oauthserver').controller('LoginPageController', [
  '$scope',
  '$window',
  'loginService',
  '$log',
  function($scope, $window, loginService, $log) {
    var clickedLogin = false;

    $scope.needsTwoFactorAuthentication = false;
    $scope.login = "";
    $scope.password = "";
    $scope.securityCode = "";
    $scope.formErrors = {};

    $scope.$watch('login', function() {
      $scope.securityCode = "";
      $scope.needsTwoFactorAuthentication = false;
    });

    $scope.$watch('password', function() {
      $scope.securityCode = "";
      $scope.needsTwoFactorAuthentication = false;
    });

    $scope.$watch('securityCode', function() {
      validate();
    });

    $scope.next = function() {
      clickedLogin = true;

      if(!validate()) {
        return;
      }

      loginService
        .validateLogin($scope.login, $scope.password, $scope.securityCode)
        .then(function(result) {
          var response = result.status;
          if(response === loginService.responses.ok) {
            if(result.url) {
              $window.location.href = result.url;
            }

          } else if(response === loginService.responses.invalidSecurityCode) {
            if(!$scope.needsTwoFactorAuthentication) {
              $scope.needsTwoFactorAuthentication = true;
              validate();
            } else {
              $scope.formErrors.securityCode = 'invalid';
            }

          } else {
            $scope.formErrors.password = 'invalid';
          }
        });
    };

    function validate() {
      var flag = true;
      $scope.formErrors.login = null;
      $scope.formErrors.password = null;
      $scope.formErrors.securityCode = null;

      if(!clickedLogin) {
        return true;
      }

      if(!$scope.login) {
        $scope.formErrors.login = 'required';
        flag = false;
      }

      if(!$scope.password) {
        $scope.formErrors.password = 'required';
        flag = false;
      }

      if($scope.needsTwoFactorAuthentication) {
        if(!$scope.securityCode || $scope.securityCode.length !== 6) {
          $scope.formErrors.securityCode = 'required';
          flag = false;
        }
      }

      return flag;
    }
  }
]);

angular.module('oauthserver').factory('loginService', [
  '$http',
  '$q',
  '$window',
  'api',
  'errors',
  '$log',
  function($http, $q, $window, api, errors, $log) {
    var self = {
      validateLogin: validateLogin,

      responses: {
        ok : 'ok',
        invalidPassword: 'invalid_password',
        invalidSecurityCode: 'invalid_security_code',
      },
    };

    function getParameterByName(name) {
      name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
      var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
      return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }

    function validateLogin(login, password, securityCode) {
      var d = $q.defer();

      var request = {
        'client_id': getParameterByName('client_id'),
        'redirect_url': getParameterByName('redirect_url'),
        'response_type': getParameterByName('response_type'),
        'scope': getParameterByName('scope'),
        'state': getParameterByName('state'),

        'login': login,
        'password': password,
        'securityCode': securityCode,
      };

      $http({
        method: 'POST',
        url: api.resource('/login/oauth/authorize'),
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'application/json',
        },
        transformRequest: function(obj) {
          var str = [];
          for(var p in obj) {
            str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
          }
          return str.join("&");
        },
        data: request,
      })
        .then(function(result) {
          var response = result.data.status;
          if(response !== self.responses.ok &&
             response !== self.responses.invalidPassword &&
             response !== self.responses.invalidSecurityCode)
          {
            $log.error('error: unknown response:', response);
            errors.custom('An error occurred while communicating with the login server.');
            return;
          }

          d.resolve(result.data);

        }, function(result) {
          if(result.status === 401) {
            if(result.data.status === self.responses.invalidPassword ||
               result.data.status === self.responses.invalidSecurityCode)
            {
              d.resolve(result.data);
              return;
            }
          }

          errors.backend(result);
        });

      return d.promise;
    }

    return self;
  }
]);

angular.module('oauthserver').factory('errors', [
  '$mdToast',
  '$log',
  function($mdToast, $log) {
    var self = {
      backend: backend,
      custom: custom,
    };

    function show(message) {
      $mdToast.show(
        $mdToast.simple().content(message).hideDelay(0)
      );
    }

    function backend(httpError) {
      $log.error('Backend error:', httpError);
      show('We could not contact the authorization server.');
    }

    function custom(message) {
      $log.error('Custom error:', message);
      show(message);
    }

    return self;
  }
]);
  </script>
</body>
</html>